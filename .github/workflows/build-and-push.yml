name: Build and push Docker image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase owner for image tag
        run: |
          echo "LOWER_OWNER=$(echo $GITHUB_REPOSITORY_OWNER | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Install repo2docker
        run: |
          python -m pip install --upgrade pip
          pip install jupyter-repo2docker

      - name: Build image with repo2docker
        env:
          DOCKER_BUILDKIT: 1
        run: |
          # build image; ask repo2docker to produce a deterministic image name
          IMAGE_NAME="r2d-${{ github.sha }}"
          echo "Using image name: $IMAGE_NAME"
          jupyter-repo2docker --image-name "$IMAGE_NAME" --no-run --user-id=1000 --user-name=jovyan .

      - name: Tag and push image to GHCR
        run: |
          echo "Listing docker images for debugging:"
          docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}"

          # try to find repo2docker-produced image (repository usually starts with r2d-)
          IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep '^r2d-' | head -n1 || true)
          if [ -z "$IMAGE" ]; then
            # fallback: any repository name containing 'r2d-'
            IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep 'r2d-' | head -n1 || true)
          fi

          if [ -z "$IMAGE" ]; then
            echo "Could not find repo2docker image; listing images with details:" 
            docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" || true
            exit 1
          fi

          echo "Found image: $IMAGE"
          docker tag "$IMAGE" ghcr.io/${{ env.LOWER_OWNER }}/sql_book:latest
          docker tag "$IMAGE" ghcr.io/${{ env.LOWER_OWNER }}/sql_book:${{ github.sha }}
          docker push ghcr.io/${{ env.LOWER_OWNER }}/sql_book:latest
          docker push ghcr.io/${{ env.LOWER_OWNER }}/sql_book:${{ github.sha }}
