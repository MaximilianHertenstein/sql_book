name: Build and push Docker image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase owner for image tag
        run: |
          echo "LOWER_OWNER=$(echo $GITHUB_REPOSITORY_OWNER | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Install repo2docker
        run: |
          python -m pip install --upgrade pip
          pip install jupyter-repo2docker==2024.07.0
          
      - name: Build, detect repo2docker image, tag and push to GHCR
        env:
          DOCKER_BUILDKIT: 1
        run: |
          set -euo pipefail

          echo "Listing docker images before build:"
          docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" > /tmp/images_before.txt || true
          cat /tmp/images_before.txt

          echo "Running repo2docker (logs -> /tmp/r2d-build.log)"
          # run and capture logs
          if ! jupyter-repo2docker --no-run --user-id=1000 --user-name=jovyan . 2>&1 | tee /tmp/r2d-build.log; then
            echo "repo2docker build failed!"
            echo "--- repo2docker log (last 200 lines) ---"
            tail -n 200 /tmp/r2d-build.log || true
            exit 1
          fi

          echo "Listing docker images after build:"
          docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" > /tmp/images_after.txt || true
          cat /tmp/images_after.txt

          # try to detect new image by diffing before/after
          NEW=$(comm -13 <(sort /tmp/images_before.txt) <(sort /tmp/images_after.txt) | awk '{print $1}' | head -n1 || true)

          if [ -z "$NEW" ]; then
            echo "No new image detected by diff; attempting to parse repo2docker log."
            # common repo2docker messages containing the image id/name
            NEW_LOG=$(grep -Eo 'r2d-[0-9a-f]+' /tmp/r2d-build.log | head -n1 || true)
            if [ -n "$NEW_LOG" ]; then
              # try to find repository:tag containing that substring
              NEW=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$NEW_LOG" | head -n1 || true)
            fi
          fi

          echo "Detected image: '${NEW:-<none>}'"

          if [ -z "$NEW" ]; then
            echo "Could not find repo2docker image; full docker images list:" 
            docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" || true
            echo "--- repo2docker log ---"
            sed -n '1,200p' /tmp/r2d-build.log || true
            exit 1
          fi

          docker tag "$NEW" ghcr.io/${{ env.LOWER_OWNER }}/sql_book:latest
          docker tag "$NEW" ghcr.io/${{ env.LOWER_OWNER }}/sql_book:${{ github.sha }}
          docker push ghcr.io/${{ env.LOWER_OWNER }}/sql_book:latest
          docker push ghcr.io/${{ env.LOWER_OWNER }}/sql_book:${{ github.sha }}
