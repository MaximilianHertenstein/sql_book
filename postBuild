#!/bin/bash
set -euo pipefail

# Simplified postBuild: ensure MySQL client/server use /tmp/mysql.sock
CFG=/etc/mysql/my.cnf
echo "Ensuring MySQL socket config in $CFG"
if [ ! -f "$CFG" ]; then
  touch "$CFG"
fi

# If the socket line is not present, append the minimal config
if grep -q "socket=/tmp/mysql.sock" "$CFG" 2>/dev/null; then
  echo "Socket config already present in $CFG"
else
  # Prefer to append directly if file is writable
  if [ -w "$CFG" ]; then
    cat >> "$CFG" <<'EOF'

[server]
socket=/tmp/mysql.sock

[client]
socket=/tmp/mysql.sock
EOF
    echo "Appended socket config to $CFG"
  # Otherwise try writing a conf file into /etc/mysql/conf.d if writable
  elif [ -d /etc/mysql/conf.d ] && [ -w /etc/mysql/conf.d ]; then
    CONF=/etc/mysql/conf.d/xeus-sql.cnf
    cat > "$CONF" <<'EOF'
[server]
socket=/tmp/mysql.sock

[client]
socket=/tmp/mysql.sock
EOF
    echo "Wrote socket config to $CONF"
  # Try using sudo+tee if sudo is available
  elif command -v sudo >/dev/null 2>&1; then
    printf '\n[server]\nsocket=/tmp/mysql.sock\n\n[client]\nsocket=/tmp/mysql.sock\n' | sudo tee -a "$CFG" >/dev/null
    echo "Appended socket config to $CFG using sudo"
  else
    # Fallback: write client-only config in user's home (won't affect server)
    USERCFG="$HOME/.my.cnf"
    cat >> "$USERCFG" <<'EOF'
[client]
socket=/tmp/mysql.sock
EOF
    echo "Warning: could not write to /etc; wrote client socket config to $USERCFG (server socket not set system-wide)."
  fi
fi

echo "postBuild done. This script no longer starts mysqld or creates databases. Start the server in the session with start_mysql.sh."
  echo "Creating database and example user (using conda mysqld)"

# Ensure the repo start wrapper is executable so Binder will use it at container start
chmod +x ./start || true
chmod +x ./.binder/start || true

# Pre-initialize a datadir at build time to speed up runtime startup on Binder.
DATADIR=/tmp/mysql-data
if command -v mysqld >/dev/null 2>&1; then
  echo "Pre-initializing MySQL datadir at $DATADIR (build time)"
  mkdir -p "$DATADIR"
  chmod 0777 "$DATADIR" || true
  if [ ! -f "$DATADIR/ibdata1" ]; then
    mysqld --initialize-insecure --datadir="$DATADIR" >/dev/null 2>&1 || true
    echo "Datadir initialized"
  else
    echo "Datadir already initialized"
  fi
else
  echo "mysqld not found at build time; skipping datadir pre-initialization"
fi
