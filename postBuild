#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive

echo "Installing MariaDB server (for binder MySQL support)"
apt-get update
apt-get install -y mariadb-server

# Ensure client/server use the socket under /tmp
if [ -f /etc/mysql/my.cnf ]; then
  sed -i 's|socket\s*=.*|socket = /tmp/mysql.sock|g' /etc/mysql/my.cnf || true
fi

echo "Starting temporary mysqld to create database and user"
# Start mysqld in background; try service, otherwise use mysqld_safe
if command -v service >/dev/null 2>&1; then
  service mysql start || true
fi
if ! mysqladmin ping --silent --socket=/tmp/mysql.sock >/dev/null 2>&1; then
  mysqld_safe --socket=/tmp/mysql.sock &
  # give it some time
  for i in {1..20}; do
    if mysqladmin ping --silent --socket=/tmp/mysql.sock >/dev/null 2>&1; then
      break
    fi
    sleep 1
  done
fi

echo "Creating database and example user"
mysql --socket=/tmp/mysql.sock -e "CREATE DATABASE IF NOT EXISTS dbname; CREATE USER IF NOT EXISTS 'user1'@'localhost' IDENTIFIED BY 'Password123#@!'; GRANT ALL PRIVILEGES ON dbname.* TO 'user1'@'localhost'; FLUSH PRIVILEGES;"

echo "Stopping temporary mysqld"
if command -v service >/dev/null 2>&1; then
  service mysql stop || true
fi
if mysqladmin --socket=/tmp/mysql.sock ping >/dev/null 2>&1; then
  mysqladmin --socket=/tmp/mysql.sock shutdown || true
fi

echo "postBuild finished: MariaDB installed and database 'dbname' created."
