<script type="module">
    // Minimal PGlite loader: import once and expose the constructor/object on window.
    try{
        const mod = await import('https://cdn.jsdelivr.net/npm/@electric-sql/pglite@0.3.15/dist/index.js');
        const P = mod && (mod.PGlite || mod.default || mod);
        window.PGlite = P;
        // start instance initialization early
        window._pgliteReady = (async ()=>{
            try{
                const ctor = window.PGlite;
                const inst = (typeof ctor === 'function') ? new ctor() : ctor;
                if(inst && typeof inst.init === 'function') await inst.init();
                window._pglite = inst;
                return inst;
            }catch(e){ console.warn('pglite init failed:', e); return null }
        })();
    }catch(e){ console.warn('failed to import pglite module', e) }
</script>

<script src="https://unpkg.com/@antonz/runno@0.6.1/dist/runno.js"></script>
<script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/engine/wasi.js"></script>
<script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.js"></script>

<!-- Minimal adapter: assumes window._pgliteReady resolves to an instance with a query/exec API -->
<script>
    (function(){
        const adapter = {
            init: async function(){
                if(window._pglite) return window._pglite;
                return await window._pgliteReady;
            },
            exec: async function(req){
                try{
                    const inst = await adapter.init();
                    if(!inst) return { ok:false, duration:0, stdout:'', stderr:'pglite not available' };
                    const sql = (req && req.files && req.files['']) ? req.files[''] : (typeof req === 'string' ? req : '');
                    if(!sql) return { ok:false, duration:0, stdout:'', stderr:'No SQL provided' };
                    let rows = null;
                    if(typeof inst.query === 'function') rows = await inst.query(sql);
                    else if(typeof inst.exec === 'function') rows = await inst.exec(sql);
                    else if(typeof inst.run === 'function') rows = await inst.run(sql);
                    else if(typeof inst.evaluate === 'function') rows = await inst.evaluate(sql);
                    else throw new Error('no supported execution method on pglite instance');
                    // normalize
                    if(rows && typeof rows === 'object'){
                        if(Array.isArray(rows)){}
                        else if(Array.isArray(rows.rows)) rows = rows.rows;
                        else if(Array.isArray(rows.result)) rows = rows.result;
                    }
                    const stdout = Array.isArray(rows) ? JSON.stringify(rows) : (typeof rows === 'string' ? rows : JSON.stringify(rows));
                    return { ok:true, duration:0, stdout, stderr:'' };
                }catch(e){ return { ok:false, duration:0, stdout:'', stderr: String(e) } }
            }
        };
        window.codapi = window.codapi || {};
        window.codapi.engines = window.codapi.engines || {};
        window.codapi.engines.pglite = adapter;
        console.log('[pglite] minimal adapter installed');
    })();
</script>

<script src="https://unpkg.com/sql-workbench-embedded@0.1.2"></script>
