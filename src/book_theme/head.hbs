<script type="module">
    const fail = (label, err) => (console.warn(label, err), null);
    try {
        const mod = await import('https://cdn.jsdelivr.net/npm/@electric-sql/pglite@0.3.15/dist/index.js');
        window.PGlite = mod?.PGlite || mod?.default || mod;
        window._pgliteReady = (async () => {
            try {
                const base = window.PGlite;
                const inst = typeof base === 'function' ? new base() : base;
                if (inst?.init) await inst.init();
                return (window._pglite = inst);
            } catch (e) {
                return fail('pglite init failed:', e);
            }
        })();
    } catch (e) {
        fail('failed to import pglite module', e);
    }
</script>

<script src="https://unpkg.com/@antonz/runno@0.6.1/dist/runno.js"></script>
<script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/engine/wasi.js"></script>
<script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.js"></script>

<script>
    (() => {
        const ok = (stdout) => ({ ok: true, duration: 0, stdout, stderr: '' });
        const err = (stderr) => ({ ok: false, duration: 0, stdout: '', stderr });
        const getSql = (req) => req?.files?.[''] || (typeof req === 'string' ? req : '');

        const adapter = {
            init: async () => window._pglite || window._pgliteReady,
            exec: async (req) => {
                try {
                    const inst = await adapter.init();
                    if (!inst) return err('pglite not available');

                    const sql = getSql(req);
                    if (!sql) return err('No SQL provided');

                    const fn = [inst.query, inst.exec, inst.run, inst.evaluate].find(
                        (candidate) => typeof candidate === 'function'
                    );
                    if (!fn) throw new Error('no supported execution method on pglite instance');

                    let result = await fn.call(inst, sql);
                    if (!Array.isArray(result)) result = result?.rows || result?.result || result;
                    return ok(typeof result === 'string' ? result : JSON.stringify(result));
                } catch (e) {
                    return err(String(e));
                }
            },
        };
        window.codapi = window.codapi || {};
        window.codapi.engines = window.codapi.engines || {};
        window.codapi.engines.pglite = adapter;
        console.log('[pglite] minimal adapter installed');
    })();
</script>

<script src="https://unpkg.com/sql-workbench-embedded@0.1.2"></script>
