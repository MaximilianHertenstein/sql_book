<script type="module">
    try {
        const mod = await import('https://cdn.jsdelivr.net/npm/@electric-sql/pglite@0.3.15/dist/index.js');
        const P = mod?.PGlite || mod?.default || mod;
        window._pgliteReady = (async () => {
            try {
                const inst = typeof P === 'function' ? new P() : P;
                if (inst?.init) await inst.init();
                return (window._pglite = inst);
            } catch (e) {
                console.warn('pglite init failed:', e);
                return null;
            }
        })();
    } catch (e) {
        console.warn('failed to import pglite module', e);
        window._pgliteReady = Promise.resolve(null);
    }
</script>

<script src="https://unpkg.com/@antonz/runno@0.6.1/dist/runno.js"></script>
<script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/engine/wasi.js"></script>
<script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.js"></script>

<script>
    window.codapi = window.codapi || {};
    window.codapi.engines = window.codapi.engines || {};
    window.codapi.engines.pglite = {
        exec: async (req) => {
            try {
                const inst = window._pglite || (await window._pgliteReady);
                if (!inst) return { ok: false, duration: 0, stdout: '', stderr: 'pglite not available' };

                const sql = req?.files?.[''] || (typeof req === 'string' ? req : '');
                if (!sql) return { ok: false, duration: 0, stdout: '', stderr: 'No SQL provided' };

                const fn = inst.query || inst.exec || inst.run || inst.evaluate;
                if (typeof fn !== 'function') throw new Error('no supported execution method on pglite instance');

                let result = await fn.call(inst, sql);
                if (!Array.isArray(result)) result = result?.rows || result?.result || result;
                return {
                    ok: true,
                    duration: 0,
                    stdout: typeof result === 'string' ? result : JSON.stringify(result),
                    stderr: '',
                };
            } catch (e) {
                return { ok: false, duration: 0, stdout: '', stderr: String(e) };
            }
        },
    };
</script>

<script src="https://unpkg.com/sql-workbench-embedded@0.1.2"></script>
